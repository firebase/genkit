diff --git a/py/packages/genkit/src/genkit/core/reflection.py b/py/packages/genkit/src/genkit/core/reflection.py
index 91bdfdc11..ffa757f17 100644
--- a/py/packages/genkit/src/genkit/core/reflection.py
+++ b/py/packages/genkit/src/genkit/core/reflection.py
@@ -426,6 +426,8 @@ def create_reflection_asgi_app(
                 trace_id_event.set()
 
             finally:
+                if not trace_id_event.is_set():
+                    trace_id_event.set()
                 # Signal end of stream
                 chunk_queue.put_nowait(None)
                 if run_trace_id:
@@ -516,8 +518,9 @@ def create_reflection_asgi_app(
                 }
             except Exception as e:
                 action_error = e
-                # Still set the event so the response can proceed
-                trace_id_event.set()
+            finally:
+                if not trace_id_event.is_set():
+                    trace_id_event.set()
 
         # Start the action immediately so trace ID becomes available ASAP
         action_task = asyncio.create_task(run_action_and_get_result())
diff --git a/py/packages/genkit/tests/genkit/ai/genkit_api_test.py b/py/packages/genkit/tests/genkit/ai/genkit_api_test.py
index 9b83dcc14..959245d6f 100644
--- a/py/packages/genkit/tests/genkit/ai/genkit_api_test.py
+++ b/py/packages/genkit/tests/genkit/ai/genkit_api_test.py
@@ -6,6 +6,7 @@
 """Tests for the Genkit extra API methods."""
 
 from typing import Any
+from unittest import mock
 from unittest.mock import AsyncMock, MagicMock
 
 import pytest
@@ -192,15 +193,6 @@ async def test_flush_tracing() -> None:
     mock_provider = MagicMock(spec=TracerProvider)
     mock_provider.force_flush = MagicMock()
 
-    # We can't easily mock the global provider if it's already set,
-    # but we can check if it calls force_flush if it is a TracerProvider.
-
-    trace_api.get_tracer_provider()
-    trace_api.set_tracer_provider(mock_provider)
-    try:
+    with mock.patch.object(trace_api, 'get_tracer_provider', return_value=mock_provider):
         await ai.flush_tracing()
         mock_provider.force_flush.assert_called_once()
-    finally:
-        # Note: set_tracer_provider can only be called once in real OTel,
-        # but in tests we might be using a mock.
-        pass
diff --git a/py/packages/genkit/tests/genkit/core/trace/default_exporter_test.py b/py/packages/genkit/tests/genkit/core/trace/default_exporter_test.py
index b0b0d7569..ae5b331eb 100644
--- a/py/packages/genkit/tests/genkit/core/trace/default_exporter_test.py
+++ b/py/packages/genkit/tests/genkit/core/trace/default_exporter_test.py
@@ -283,13 +283,16 @@ def test_extract_span_data_basic_fields() -> None:
 
     data = extract_span_data(mock_span)
 
-    assert data['traceId'] == '12345'
+    trace_id_hex = format(12345, '032x')
+    span_id_hex = format(67890, '016x')
+
+    assert data['traceId'] == trace_id_hex
     assert 'spans' in data
-    assert 67890 in data['spans']
+    assert span_id_hex in data['spans']
 
-    span_info = data['spans'][67890]
-    assert span_info['spanId'] == '67890'
-    assert span_info['traceId'] == '12345'
+    span_info = data['spans'][span_id_hex]
+    assert span_info['spanId'] == span_id_hex
+    assert span_info['traceId'] == trace_id_hex
     assert span_info['displayName'] == 'test-span'
     assert span_info['startTime'] == 1000.0  # Converted to milliseconds
     assert span_info['endTime'] == 2000.0  # Converted to milliseconds
@@ -301,7 +304,8 @@ def test_extract_span_data_with_attributes() -> None:
 
     data = extract_span_data(mock_span)
 
-    span_info = data['spans'][67890]
+    span_id_hex = format(67890, '016x')
+    span_info = data['spans'][span_id_hex]
     assert span_info['attributes'] == {'key1': 'value1', 'key2': 123}
 
 
@@ -315,8 +319,10 @@ def test_extract_span_data_with_parent_span() -> None:
 
     data = extract_span_data(mock_span)
 
-    span_info = data['spans'][67890]
-    assert span_info['parentSpanId'] == '11111'
+    span_id_hex = format(67890, '016x')
+    parent_span_id_hex = format(11111, '016x')
+    span_info = data['spans'][span_id_hex]
+    assert span_info['parentSpanId'] == parent_span_id_hex
 
 
 def test_extract_span_data_without_parent_span() -> None:
@@ -326,7 +332,8 @@ def test_extract_span_data_without_parent_span() -> None:
 
     data = extract_span_data(mock_span)
 
-    span_info = data['spans'][67890]
+    span_id_hex = format(67890, '016x')
+    span_info = data['spans'][span_id_hex]
     assert 'parentSpanId' not in span_info
 
     # Root span should have displayName, startTime, endTime at top level
@@ -339,7 +346,8 @@ def test_extract_span_data_includes_status() -> None:
 
     data = extract_span_data(mock_span)
 
-    span_info = data['spans'][67890]
+    span_id_hex = format(67890, '016x')
+    span_info = data['spans'][span_id_hex]
     assert 'status' in span_info
     assert span_info['status']['code'] == trace_api.StatusCode.OK.value  # OK status is 1
 
@@ -350,7 +358,8 @@ def test_extract_span_data_includes_instrumentation_library() -> None:
 
     data = extract_span_data(mock_span)
 
-    span_info = data['spans'][67890]
+    span_id_hex = format(67890, '016x')
+    span_info = data['spans'][span_id_hex]
     assert span_info['instrumentationLibrary'] == {
         'name': 'genkit-tracer',
         'version': 'v1',
@@ -363,7 +372,8 @@ def test_extract_span_data_handles_none_times() -> None:
 
     data = extract_span_data(mock_span)
 
-    span_info = data['spans'][67890]
+    span_id_hex = format(67890, '016x')
+    span_info = data['spans'][span_id_hex]
     assert span_info['startTime'] == 0
     assert span_info['endTime'] == 0
 
