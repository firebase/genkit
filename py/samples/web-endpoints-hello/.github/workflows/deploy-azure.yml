# Copyright 2026 Google LLC
# SPDX-License-Identifier: Apache-2.0
#
# Deploy to Azure Container Apps.
#
# STATUS: DISABLED (manual trigger only).
#
# Prerequisites:
#   1. Create a resource group and Azure Container Registry (ACR).
#   2. Configure OIDC federated credentials for GitHub Actions:
#      https://learn.microsoft.com/azure/developer/github/connect-from-azure
#   3. Set these repository secrets:
#      - AZURE_CLIENT_ID       — App registration client ID
#      - AZURE_TENANT_ID       — Azure AD tenant ID
#      - AZURE_SUBSCRIPTION_ID — Azure subscription ID
#      - AZURE_ACR_NAME        — ACR name (e.g. genkitacr)
#      - AZURE_RESOURCE_GROUP  — Resource group name
#      - GEMINI_API_KEY        — Gemini API key for the deployed service

name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Container App name'
        required: true
        default: 'genkit-endpoints'
      location:
        description: 'Azure location'
        required: true
        default: 'eastus'

defaults:
  run:
    working-directory: py/samples/web-endpoints-hello

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.AZURE_ACR_NAME }}

      - name: Build and push container image
        env:
          ACR_NAME: ${{ secrets.AZURE_ACR_NAME }}
          IMAGE_TAG: ${{ github.sha }}
          APP_NAME: ${{ inputs.app_name }}
        run: |
          ACR_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)
          docker build -f Containerfile -t "$ACR_SERVER/$APP_NAME:$IMAGE_TAG" .
          docker push "$ACR_SERVER/$APP_NAME:$IMAGE_TAG"
          echo "image=$ACR_SERVER/$APP_NAME:$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: Deploy to Container Apps
        env:
          ACR_NAME: ${{ secrets.AZURE_ACR_NAME }}
          RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          APP_NAME: ${{ inputs.app_name }}
          LOCATION: ${{ inputs.location }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          ACR_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)

          az extension add --name containerapp --upgrade --yes 2>/dev/null || true

          if az containerapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
            echo "Updating existing Container App..."
            az containerapp update \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$ACR_SERVER/$APP_NAME:$IMAGE_TAG" \
              --set-env-vars \
                "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
                "PORT=8080"
          else
            echo "Creating new Container App..."
            ACR_USER=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
            ACR_PASS=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)

            az containerapp create \
              --name "$APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "${APP_NAME}-env" \
              --image "$ACR_SERVER/$APP_NAME:$IMAGE_TAG" \
              --registry-server "$ACR_SERVER" \
              --registry-username "$ACR_USER" \
              --registry-password "$ACR_PASS" \
              --target-port 8080 \
              --ingress external \
              --min-replicas 0 \
              --max-replicas 10 \
              --cpu 1 \
              --memory 2.0Gi \
              --env-vars \
                "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
                "PORT=8080"
          fi

      - name: Show service URL
        env:
          APP_NAME: ${{ inputs.app_name }}
          RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
        run: |
          FQDN=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null || echo "")
          if [ -n "$FQDN" ]; then
            echo "Service URL: https://$FQDN"
            echo "Test: curl https://$FQDN/health"
          fi
