#!/bin/bash
# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# Create Release Tag and GitHub Release for Python SDK
#
# Usage:
#   ./bin/create_release <VERSION>
#
# Example:
#   ./bin/create_release 0.5.0
#
# This script will:
#   1. Verify you're on main branch with latest changes
#   2. Create an annotated git tag (py/v<VERSION>)
#   3. Push the tag to origin
#   4. Create a GitHub release using the PR description file

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check arguments
if [ $# -lt 1 ]; then
    echo -e "${RED}Usage: $0 <VERSION>${NC}"
    echo "Example: $0 0.5.0"
    exit 1
fi

VERSION="$1"
TAG_NAME="py/v${VERSION}"
PR_DESCRIPTION_FILE=".github/PR_DESCRIPTION_${VERSION}.md"

echo -e "${BLUE}=== Genkit Python SDK Release: v${VERSION} ===${NC}"
echo ""

# Check we're in the py directory or repo root
if [ -f "pyproject.toml" ] && [ -d "packages" ]; then
    # We're in py/
    cd ..
elif [ -d "py/packages" ]; then
    # We're in repo root
    :
else
    echo -e "${RED}Error: Must run from repo root or py/ directory${NC}"
    exit 1
fi

# Navigate to py/ for version checks
cd py

# Step 1: Verify version in packages
echo -e "${YELLOW}Step 1: Verifying package versions...${NC}"
GENKIT_VERSION=$(grep "^version = " packages/genkit/pyproject.toml | cut -d'"' -f2)
if [ "$GENKIT_VERSION" != "$VERSION" ]; then
    echo -e "${RED}Error: genkit package version is ${GENKIT_VERSION}, expected ${VERSION}${NC}"
    echo "Update packages/genkit/pyproject.toml before creating release"
    exit 1
fi
echo -e "${GREEN}✓ Package version matches: ${VERSION}${NC}"

# Check PR description file exists
if [ ! -f "$PR_DESCRIPTION_FILE" ]; then
    echo -e "${RED}Error: PR description file not found: ${PR_DESCRIPTION_FILE}${NC}"
    echo "Create the file before running this script"
    exit 1
fi
echo -e "${GREEN}✓ PR description file exists${NC}"

# Go back to repo root
cd ..

# Step 2: Verify git status
echo ""
echo -e "${YELLOW}Step 2: Checking git status...${NC}"
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo -e "${RED}Error: Not on main branch (currently on: ${CURRENT_BRANCH})${NC}"
    echo "Switch to main branch: git checkout main"
    exit 1
fi
echo -e "${GREEN}✓ On main branch${NC}"

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo -e "${RED}Error: There are uncommitted changes${NC}"
    echo "Commit or stash changes before creating release"
    exit 1
fi
echo -e "${GREEN}✓ No uncommitted changes${NC}"

# Step 3: Pull latest
echo ""
echo -e "${YELLOW}Step 3: Pulling latest changes...${NC}"
git pull origin main
echo -e "${GREEN}✓ Pulled latest from origin/main${NC}"

# Step 4: Check if tag already exists
echo ""
echo -e "${YELLOW}Step 4: Checking if tag exists...${NC}"
if git tag -l "$TAG_NAME" | grep -q "$TAG_NAME"; then
    echo -e "${RED}Error: Tag ${TAG_NAME} already exists${NC}"
    echo "Delete it first if you need to recreate: git tag -d ${TAG_NAME} && git push origin :refs/tags/${TAG_NAME}"
    exit 1
fi
echo -e "${GREEN}✓ Tag ${TAG_NAME} does not exist${NC}"

# Step 5: Create tag
echo ""
echo -e "${YELLOW}Step 5: Creating annotated tag...${NC}"
git tag -a "$TAG_NAME" -m "Genkit Python SDK v${VERSION}

Release highlights:
- See py/CHANGELOG.md for full release notes
- See py/.github/PR_DESCRIPTION_${VERSION}.md for detailed changes

Published packages:
- genkit (core)
- genkit-plugin-* (22 plugins)"

echo -e "${GREEN}✓ Created tag: ${TAG_NAME}${NC}"

# Step 6: Push tag
echo ""
echo -e "${YELLOW}Step 6: Pushing tag to origin...${NC}"
git push origin "$TAG_NAME"
echo -e "${GREEN}✓ Pushed tag to origin${NC}"

# Step 7: Create GitHub release
echo ""
echo -e "${YELLOW}Step 7: Creating GitHub release...${NC}"
gh release create "$TAG_NAME" \
    --title "Genkit Python SDK v${VERSION}" \
    --notes-file "py/${PR_DESCRIPTION_FILE}"

echo -e "${GREEN}✓ Created GitHub release${NC}"

# Summary
echo ""
echo -e "${BLUE}=== Release Created Successfully ===${NC}"
echo ""
echo "Tag: ${TAG_NAME}"
echo "Release: https://github.com/firebase/genkit/releases/tag/${TAG_NAME}"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "1. Go to Actions → Publish Python Package"
echo "2. Run workflow with: publish_scope=all"
echo "3. Monitor the publish workflow"
echo "4. Verify on PyPI: pip index versions genkit"
